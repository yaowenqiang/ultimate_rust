/*
 * Rust unsafe ä»£ç æ·±å…¥å­¦ä¹ ç¤ºä¾‹
 *
 * æœ¬é¡¹ç›®æ¼”ç¤ºäº† Rust ä¸­ unsafe ä»£ç çš„å„ç§ä½¿ç”¨åœºæ™¯ã€å±é™©æ€§å’Œæœ€ä½³å®è·µï¼š
 * - å®‰å…¨ vs ä¸å®‰å…¨çš„å†…å­˜è®¿é—®
 * - unsafe å‡½æ•°å’Œ unsafe å—çš„ä½¿ç”¨
 * - è¾¹ç•Œæ£€æŸ¥çš„é‡è¦æ€§
 * - æœªå®šä¹‰è¡Œä¸ºçš„æ¦‚å¿µå’Œå±é™©
 *
 * ğŸ“š å®˜æ–¹æ–‡æ¡£é“¾æ¥ï¼š
 *
 * ğŸ”° åŸºç¡€æ¦‚å¿µ
 * 1. Rust Book - Unsafe Rust:
 *    https://doc.rust-lang.org/book/ch19-01-unsafe-rust.html
 *
 * 2. Rustonomicon (ä¸å®‰å…¨ Rust åœ£ç»):
 *    https://doc.rust-lang.org/nomicon/
 *
 * 3. Unsafe å—å‚è€ƒ:
 *    https://doc.rust-lang.org/reference/unsafe-blocks.html
 *
 * âš™ï¸ é«˜çº§æ¦‚å¿µ
 * 4. ä¸å®‰å…¨ä»£ç æŒ‡å—:
 *    https://rust-lang.github.io/unsafe-code-guidelines/
 *
 * 5. ç¼–å†™ä¸å®‰å…¨ Rust:
 *    https://doc.rust-lang.org/nightly/nomicon/writing-unsafe-rust.html
 *
 * 6. åŸå§‹ç±»å‹å’Œè£¸æŒ‡é’ˆ:
 *    https://doc.rust-lang.org/std/primitive.pointer.html
 *
 * ğŸš€ ä¸­æ–‡èµ„æº
 * 7. Rustè¯­è¨€åœ£ç» - Unsafe Rust:
 *    https://course.rs/advance/unsafe.html
 *
 * 8. Rust By Example - Unsafe:
 *    https://rustwiki.org/zh-CN/rust-by-example/unsafe.html
 *
 * âš ï¸ å®‰å…¨æé†’
 * - unsafe ä¸ç­‰äºä¸å®‰å…¨ï¼Œè€Œæ˜¯å‘Šè¯‰ç¼–è¯‘å™¨"æˆ‘çŸ¥é“æˆ‘åœ¨åšä»€ä¹ˆ"
 * - ä»…åœ¨ç»å¯¹å¿…è¦ä¸”äº†è§£æ‰€æœ‰é£é™©æ—¶æ‰ä½¿ç”¨ unsafe ä»£ç 
 * - ä¼˜å…ˆå¯»æ‰¾å®‰å…¨çš„æ›¿ä»£æ–¹æ¡ˆ
 */

/// Rust unsafe ä»£ç æ¼”ç¤ºä¸»å‡½æ•°
///
/// æœ¬å‡½æ•°æ¼”ç¤ºäº† Rust ä¸­å®‰å…¨ä¸ä¸å®‰å…¨å†…å­˜è®¿é—®çš„å¯¹æ¯”ï¼š
/// 1. ä½¿ç”¨ç´¢å¼•æ“ä½œç¬¦çš„å®‰å…¨è®¿é—®ï¼ˆå¸¦è¾¹ç•Œæ£€æŸ¥ï¼‰
/// 2. ä½¿ç”¨ get() æ–¹æ³•çš„å®‰å…¨è®¿é—®ï¼ˆè¿”å› Optionï¼‰
/// 3. ä½¿ç”¨ get_unchecked() çš„ä¸å®‰å…¨è®¿é—®ï¼ˆæ— è¾¹ç•Œæ£€æŸ¥ï¼‰
/// 4. unsafe å‡½æ•°çš„è°ƒç”¨
fn main() {
    println!("ğŸ¦€ Rust unsafe ä»£ç æ¼”ç¤º");
    println!("=======================");

    // åˆ›å»ºä¸€ä¸ªåŒ…å« 5 ä¸ªå…ƒç´ çš„å‘é‡
    // å‘é‡åœ¨å †ä¸Šåˆ†é…å†…å­˜ï¼ŒåŒ…å«è¿ç»­çš„æ•´æ•°å€¼
    let my_ves = vec![1, 2, 3, 4, 5];
    println!("åˆ›å»ºå‘é‡: {:?}", my_ves);

    // æ–¹å¼ 1: å®‰å…¨çš„æ•°ç»„è®¿é—®æ–¹å¼ - ä½¿ç”¨ç´¢å¼•æ“ä½œç¬¦
    // Rust ä¼šåœ¨è¿è¡Œæ—¶æ£€æŸ¥ç´¢å¼•æ˜¯å¦è¶Šç•Œï¼Œå¦‚æœè¶Šç•Œä¼š panic
    println!("\nâœ… æ–¹å¼ 1: ç´¢å¼•è®¿é—®ï¼ˆå®‰å…¨ï¼Œå¸¦è¾¹ç•Œæ£€æŸ¥ï¼‰");
    println!("my_ves[0] = {}", my_ves[0]);
    println!("ç‰¹ç‚¹: è¶Šç•Œæ—¶ç¨‹åºä¼š panicï¼Œç¡®ä¿å†…å­˜å®‰å…¨");

    // è¢«æ³¨é‡Šæ‰çš„è¶Šç•Œè®¿é—®ç¤ºä¾‹
    // å–æ¶ˆæ³¨é‡Šä¼šå¯¼è‡´ panic
    // println!("my_ves[10] = {}", my_ves[10]); // è¿™ä¼š panic!

    // æ–¹å¼ 2: ä½¿ç”¨ get() æ–¹æ³•çš„å®‰å…¨è®¿é—®
    // è¿”å› Option<T> ç±»å‹ï¼Œä¼˜é›…å¤„ç†è¶Šç•Œæƒ…å†µ
    println!("\nâœ… æ–¹å¼ 2: get() æ–¹æ³•è®¿é—®ï¼ˆå®‰å…¨ï¼Œè¿”å› Optionï¼‰");
    match my_ves.get(11) {
        Some(value) => println!("my_ves.get(11) = {}", value),
        None => println!("my_ves.get(11) = Noneï¼ˆç´¢å¼•è¶Šç•Œï¼‰"),
    }

    // æ–¹å¼ 3: unsafe å—ä¸­ä½¿ç”¨ get_unchecked() æ–¹æ³•
    // âš ï¸ å±é™©ï¼šä¸è¿›è¡Œè¾¹ç•Œæ£€æŸ¥ï¼Œå¯èƒ½å¯¼è‡´æœªå®šä¹‰è¡Œä¸º
    println!("\nâš ï¸ æ–¹å¼ 3: get_unchecked() è®¿é—®ï¼ˆä¸å®‰å…¨ï¼Œæ— è¾¹ç•Œæ£€æŸ¥ï¼‰");
    println!("è¿™æ˜¯æ¼”ç¤ºå±é™©æ€§çš„ç¤ºä¾‹ - åœ¨å®é™…ä»£ç ä¸­åº”è¯¥é¿å…ï¼");
    unsafe {
        // è¿™ä¸ªè®¿é—®æ˜¯æœªå®šä¹‰è¡Œä¸ºï¼Œå› ä¸ºç´¢å¼• 11 è¶…å‡ºäº†å‘é‡èŒƒå›´ [0, 4]
        // å¯èƒ½è¯»å–åˆ°åƒåœ¾æ•°æ®ï¼Œæˆ–è€…å¯¼è‡´ç¨‹åºå´©æºƒ
        let value = my_ves.get_unchecked(11);
        println!("my_ves.get_unchecked(11) = {}", value);
        println!("è­¦å‘Š: è¿™æ˜¯æœªå®šä¹‰è¡Œä¸ºï¼Œç»“æœä¸å¯é¢„æµ‹ï¼");
    }

    // æ–¹å¼ 4: è°ƒç”¨ unsafe å‡½æ•°
    println!("\nâš ï¸ æ–¹å¼ 4: è°ƒç”¨ unsafe å‡½æ•°");
    println!("è°ƒç”¨åŒ…å«å±é™©æ“ä½œçš„ unsafe å‡½æ•°...");
    unsafe {
        my_fn();
    }

    // å®‰å…¨æ€§æ€»ç»“
    print_safety_summary();
}

/// æ¼”ç¤º unsafe å‡½æ•°çš„ä½¿ç”¨å’Œå±é™©
///
/// è¿™ä¸ªå‡½æ•°å±•ç¤ºäº† unsafe å‡½æ•°çš„å…¸å‹ç‰¹å¾ï¼š
/// - å‡½æ•°ç­¾åè¢«æ ‡è®°ä¸º unsafe
/// - åŒ…å«å¯èƒ½å¯¼è‡´æœªå®šä¹‰è¡Œä¸ºçš„æ“ä½œ
/// - éœ€è¦è°ƒç”¨è€…ç¡®ä¿å®‰å…¨æ¡ä»¶
///
/// # Safety
///
/// è°ƒç”¨æ­¤å‡½æ•°éœ€è¦æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼ˆè™½ç„¶æœ¬ç¤ºä¾‹ä¸­æ•…æ„è¿åï¼‰ï¼š
/// - ç¡®ä¿å‘é‡æœ‰è¶³å¤Ÿçš„å…ƒç´ 
/// - ç¡®ä¿ç´¢å¼•è®¿é—®ä¸ä¼šè¶Šç•Œ
/// - ç¡®ä¿å†…å­˜è®¿é—®æ˜¯æœ‰æ•ˆçš„
///
/// âš ï¸ é‡è¦è­¦å‘Šï¼š
/// è¿™ä¸ªå‡½æ•°æ•…æ„åŒ…å«å±é™©çš„ä»£ç æ¥æ¼”ç¤ºæœªå®šä¹‰è¡Œä¸ºçš„åæœ
/// åœ¨å®é™…ä»£ç ä¸­ï¼Œè¿™ç§å†™æ³•æ˜¯ç»å¯¹é”™è¯¯çš„ï¼
unsafe fn my_fn() {
    println!("è¿›å…¥äº† unsafe å‡½æ•°...");

    // åˆ›å»ºæ–°çš„å‘é‡å®ä¾‹ï¼ŒåŒ…å« 5 ä¸ªå…ƒç´ 
    let my_ves = vec![1, 2, 3, 4, 5];
    println!("å‡½æ•°å†…åˆ›å»ºå‘é‡: {:?}", my_ves);
    println!("å‘é‡æœ‰æ•ˆç´¢å¼•èŒƒå›´: 0 .. {}", my_ves.len());

    // âš ï¸ æåº¦å±é™©ï¼šè®¿é—®è¶…å‡ºå‘é‡è¾¹ç•Œçš„ç´¢å¼•
    // è¿™ä¼šå¯¼è‡´ä»¥ä¸‹é—®é¢˜ä¹‹ä¸€ï¼š
    // 1. è¯»å–åˆ°æœªåˆå§‹åŒ–çš„å†…å­˜æ•°æ®
    // 2. è¯»å–åˆ°å…¶ä»–å˜é‡çš„æ•°æ®
    // 3. è§¦å‘æ®µé”™è¯¯å¯¼è‡´ç¨‹åºå´©æºƒ
    // 4. äº§ç”Ÿä¸å¯é¢„æµ‹çš„ç»“æœ
    println!("å°è¯•è®¿é—®ç´¢å¼• 11ï¼ˆè¶Šç•Œè®¿é—®ï¼‰...");

    let value = my_ves.get_unchecked(11);
    println!("unsafe function value: {}", value);
    println!("âš ï¸ è­¦å‘Šï¼šåˆšæ‰çš„æ“ä½œæ˜¯æœªå®šä¹‰è¡Œä¸ºï¼");
}

/// æ‰“å°å®‰å…¨æ€§æ€»ç»“å’Œå»ºè®®
fn print_safety_summary() {
    println!("\nğŸ“Š å®‰å…¨æ€§æ€»ç»“");
    println!("=============");

    println!("\nâœ… å®‰å…¨çš„è®¿é—®æ–¹å¼:");
    println!("1. ä½¿ç”¨ç´¢å¼•æ“ä½œç¬¦ [] - è‡ªåŠ¨è¾¹ç•Œæ£€æŸ¥ï¼Œè¶Šç•Œæ—¶ panic");
    println!("2. ä½¿ç”¨ get() æ–¹æ³• - è¿”å› Option<T>ï¼Œä¼˜é›…å¤„ç†è¶Šç•Œ");
    println!("3. ä½¿ç”¨è¿­ä»£å™¨ - ç±»å‹å®‰å…¨ï¼Œç¼–è¯‘æ—¶ä¿è¯");

    println!("\nâš ï¸ ä¸å®‰å…¨çš„è®¿é—®æ–¹å¼:");
    println!("1. ä½¿ç”¨ get_unchecked() - æ— è¾¹ç•Œæ£€æŸ¥ï¼Œå¯èƒ½å¯¼è‡´æœªå®šä¹‰è¡Œä¸º");
    println!("2. è£¸æŒ‡é’ˆè§£å¼•ç”¨ - å®Œå…¨ç»•è¿‡ Rust çš„å®‰å…¨æ£€æŸ¥");

    println!("\nğŸ’¡ æœ€ä½³å®è·µ:");
    println!("1. ä¼˜å…ˆä½¿ç”¨å®‰å…¨çš„ API");
    println!("2. åªæœ‰åœ¨æ€§èƒ½å…³é”®ä¸”ç¡®ä¿å®‰å…¨æ—¶æ‰ä½¿ç”¨ unsafe");
    println!("3. ä¸º unsafe ä»£ç ç¼–å†™è¯¦ç»†çš„æ–‡æ¡£å’Œå®‰å…¨å¥‘çº¦");
    println!("4. å°½å¯èƒ½å°† unsafe ä»£ç å°è£…åœ¨å®‰å…¨çš„æ¥å£åé¢");

    println!("\nğŸ” æœªå®šä¹‰è¡Œä¸ºçš„åæœ:");
    println!("1. ç¨‹åºå´©æºƒ");
    println!("2. æ•°æ®æŸå");
    println!("3. å®‰å…¨æ¼æ´");
    println!("4. ä¸å¯é¢„æµ‹çš„è¡Œä¸º");

    println!("\nğŸ“š å»¶ä¼¸å­¦ä¹ :");
    println!("â€¢ Rustonomicon: https://doc.rust-lang.org/nomicon/");
    println!("â€¢ Unsafe æŒ‡å—: https://rust-lang.github.io/unsafe-code-guidelines/");
}

/*
ğŸ”— æ‰©å±•å­¦ä¹ èµ„æºï¼š

ğŸ“š å®˜æ–¹æ–‡æ¡£ï¼š
â€¢ Rust Book - Unsafe Rust: https://doc.rust-lang.org/book/ch19-01-unsafe-rust.html
â€¢ Rustonomicon (ä¸å®‰å…¨ Rust åœ£ç»): https://doc.rust-lang.org/nomicon/
â€¢ Unsafe å—å‚è€ƒ: https://doc.rust-lang.org/reference/unsafe-blocks.html
â€¢ åŸå§‹ç±»å‹æ–‡æ¡£: https://doc.rust-lang.org/std/primitive.pointer.html

ğŸ“– ä¸­æ–‡èµ„æºï¼š
â€¢ Rustè¯­è¨€åœ£ç» - Unsafe Rust: https://course.rs/advance/unsafe.html
â€¢ Rust By Example - Unsafe: https://rustwiki.org/zh-CN/rust-by-example/unsafe.html
â€¢ Rust ä¸­æ–‡ç¤¾åŒº - unsafe è®¨è®º: https://rust.cc/

âš¡ æœ€ä½³å®è·µæŒ‡å—ï¼š
â€¢ ä¸å®‰å…¨ä»£ç æŒ‡å—: https://rust-lang.github.io/unsafe-code-guidelines/
â€¢ ç¼–å†™ä¸å®‰å…¨ Rust: https://doc.rust-lang.org/nightly/nomicon/writing-unsafe-rust.html
â€¢ FFI å®‰å…¨æŒ‡å—: https://rust-lang.github.io/unsafe-code-guidelines/ffi.html

ğŸ¯ å…³é”®æ¦‚å¿µè§£æï¼š
â€¢ è¾¹ç•Œæ£€æŸ¥ (Bounds Checking): Rust åœ¨è¿è¡Œæ—¶æ£€æŸ¥æ•°ç»„/å‘é‡è®¿é—®çš„æœ‰æ•ˆæ€§
â€¢ æœªå®šä¹‰è¡Œä¸º (Undefined Behavior): ç¨‹åºè¡Œä¸ºä¸å¯é¢„æµ‹çš„ä¸¥é‡é—®é¢˜
â€¢ å†…å­˜å®‰å…¨: Rust é˜²æ­¢ç¼“å†²åŒºæº¢å‡ºã€æ‚¬å‚æŒ‡é’ˆç­‰å†…å­˜é”™è¯¯çš„æ ¸å¿ƒç‰¹æ€§
â€¢ å®‰å…¨å¥‘çº¦ (Safety Contract): unsafe å‡½æ•°è¦æ±‚è°ƒç”¨è€…ä¿è¯çš„æ¡ä»¶
â€¢ é›¶æˆæœ¬æŠ½è±¡: Rust åœ¨ä¿è¯å®‰å…¨çš„åŒæ—¶ä¸å½±å“è¿è¡Œæ—¶æ€§èƒ½

ğŸ’» å®é™…åº”ç”¨åœºæ™¯ï¼š
â€¢ FFI (å¤–éƒ¨å‡½æ•°æ¥å£): ä¸ C/C++ ä»£ç äº¤äº’
â€¢ é«˜æ€§èƒ½è®¡ç®—: åœ¨ç¡®ä¿å®‰å…¨çš„å‰æä¸‹ä¼˜åŒ–æ€§èƒ½ç“¶é¢ˆ
â€¢ åº•å±‚ç³»ç»Ÿç¼–ç¨‹: ç›´æ¥æ“ä½œç¡¬ä»¶æˆ–å†…å­˜
â€¢ è‡ªå®šä¹‰æ•°æ®ç»“æ„: å®ç°ç¼–è¯‘å™¨æ— æ³•è‡ªåŠ¨éªŒè¯çš„å®‰å…¨æ€§

âš ï¸ å®‰å…¨è­¦ç¤ºï¼š
â€¢ unsafe ä¸ç­‰äºä¸å®‰å…¨ï¼Œè€Œæ˜¯"æˆ‘äº†è§£é£é™©å¹¶æ‰¿æ‹…åæœ"
â€¢ ä½¿ç”¨ unsafe æ—¶å¿…é¡»æ‰‹åŠ¨ç»´æŠ¤ Rust çš„å®‰å…¨ä¿è¯
â€¢ ä¼˜å…ˆå¯»æ‰¾å®‰å…¨çš„æ›¿ä»£æ–¹æ¡ˆï¼Œè°¨æ…ä½¿ç”¨ unsafe
â€¢ ä¸º unsafe ä»£ç ç¼–å†™å……åˆ†çš„æµ‹è¯•å’Œæ–‡æ¡£
*/
