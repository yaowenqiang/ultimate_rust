//! # Footgun ç¤ºä¾‹ï¼šæ•°æ®ç«äº‰æ¼”ç¤º
//! 
//! è¿™æ˜¯ä¸€ä¸ª "footgun" (å®¹æ˜“å‡ºé”™çš„ä»£ç ) ç¤ºä¾‹ï¼Œç”¨äºæ¼”ç¤º Rust ä¸­ä¸å®‰å…¨çš„å¹¶å‘ç¼–ç¨‹ã€‚
//! è¿™æ®µä»£ç æ•…æ„å±•ç¤ºäº†æ•°æ®ç«äº‰çš„å±é™©æ€§å’Œä¸ç¡®å®šè¡Œä¸ºã€‚
//! 
//! **è­¦å‘Šï¼šè¿™æ˜¯åé¢æ•™æï¼Œå±•ç¤ºäº†ä»€ä¹ˆæ˜¯ä¸åº”è¯¥åšçš„ï¼**

use std::{ptr::addr_of, thread};

// å…¨å±€å¯å˜é™æ€å˜é‡ - è¿™æ˜¯å±é™©çš„æ ¹æºï¼
// åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­ï¼Œæ²¡æœ‰åŒæ­¥æœºåˆ¶çš„å…¨å±€å¯å˜çŠ¶æ€ä¼šå¯¼è‡´æ•°æ®ç«äº‰
static mut COUNTER: i32 = 0;

fn main() {
    println!("å¼€å§‹æ•°æ®ç«äº‰æ¼”ç¤º...");
    println!("æœŸæœ›ç»“æœï¼š1000 çº¿ç¨‹ Ã— 1000 æ¬¡é€’å¢ = 1,000,000");
    println!("å®é™…ç»“æœå°†å› æ•°æ®ç«äº‰è€Œå˜å¾—ä¸å¯é¢„æµ‹\n");

    // å­˜å‚¨æ‰€æœ‰çº¿ç¨‹å¥æŸ„çš„å®¹å™¨
    let mut handles = Vec::new();
    
    // åˆ›å»º 1000 ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½ä¼šå°è¯•ä¿®æ”¹åŒä¸€ä¸ªå…¨å±€å˜é‡
    for i in 0..1000 {
        let handle = thread::spawn(move || {
            // æ¯ä¸ªçº¿ç¨‹æ‰§è¡Œ 1000 æ¬¡é€’å¢æ“ä½œ
            for _ in 0..1_000 {
                unsafe {
                    // å±é™©æ“ä½œï¼å¤šä¸ªçº¿ç¨‹åŒæ—¶ä¿®æ”¹å…¨å±€å˜é‡è€Œæ²¡æœ‰åŒæ­¥
                    // è¿™ä¼šå¯¼è‡´ï¼š
                    // 1. æ•°æ®ç«äº‰ (data race)
                    // 2. ä¸ç¡®å®šçš„ç»“æœ
                    // 3. å¯èƒ½çš„å†…å­˜æŸå
                    COUNTER += 1;
                }
            }
        });
        handles.push(handle);
        
        // æ¯åˆ›å»º 100 ä¸ªçº¿ç¨‹å°±æ˜¾ç¤ºä¸€æ¬¡è¿›åº¦
        if (i + 1) % 100 == 0 {
            println!("å·²åˆ›å»º {} ä¸ªçº¿ç¨‹...", i + 1);
        }
    }

    println!("æ‰€æœ‰çº¿ç¨‹å·²å¯åŠ¨ï¼Œç­‰å¾…å®Œæˆ...");
    
    // ç­‰å¾…æ‰€æœ‰çº¿ç¨‹å®Œæˆ
    // join() ç¡®ä¿ä¸»çº¿ç¨‹ç­‰å¾…æ‰€æœ‰å­çº¿ç¨‹æ‰§è¡Œå®Œæ¯•
    handles.into_iter().for_each(|h| h.join().unwrap());

    // è¯»å–æœ€ç»ˆç»“æœ
    // ä½¿ç”¨ addr_of! å®é¿å…åˆ›å»ºå¯¹å¯å˜é™æ€å˜é‡çš„å…±äº«å¼•ç”¨
    // è¿™æ˜¯ Rust 2024 ç‰ˆæœ¬çš„è¦æ±‚
    unsafe {
        let final_count = *addr_of!(COUNTER);
        println!("\n=== ç»“æœåˆ†æ ===");
        println!("æœ€ç»ˆè®¡æ•°å€¼: {}", final_count);
        println!("æœŸæœ›å€¼: 1,000,000");
        println!("ä¸¢å¤±çš„é€’å¢: {}", 1_000_000 - final_count);
        println!("ä¸¢å¤±ç‡: {:.2}%", (1_000_000 - final_count) as f64 / 10_000.0);
        
        if final_count < 1_000_000 {
            println!("\nâš ï¸  æ•°æ®ç«äº‰å¯¼è‡´äº†é€’å¢æ“ä½œçš„ä¸¢å¤±ï¼");
            println!("è¿™å°±æ˜¯ä¸ºä»€ä¹ˆéœ€è¦ä½¿ç”¨ Mutexã€Atomic ç­‰åŒæ­¥åŸè¯­çš„åŸå› ã€‚");
        } else {
            println!("\nğŸ² è¿™æ¬¡è¿è¡Œå¾ˆå¹¸è¿ï¼Œä½†ç»“æœä»ç„¶æ˜¯ä¸å¯é¢„æµ‹çš„ï¼");
        }
    }

    println!("\nğŸ’¡ æ­£ç¡®çš„åšæ³•åº”è¯¥ä½¿ç”¨:");
    println!("   - std::sync::Mutex<i32> ç”¨äºäº’æ–¥è®¿é—®");
    println!("   - std::sync::atomic::AtomicI32 ç”¨äºåŸå­æ“ä½œ");
    println!("   - æˆ–å…¶ä»–é€‚å½“çš„åŒæ­¥åŸè¯­");
}
