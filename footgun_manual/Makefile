# Footgun Manual - Makefile
# ç®€åŒ–é¡¹ç›®æ„å»ºå’Œè¿è¡Œçš„ä¾¿æ·å·¥å…·

.PHONY: help run run-release optimized optimized-release compare bench clean check fmt clippy test all install-deps

# é»˜è®¤ç›®æ ‡ï¼šæ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
help:
	@echo "ğŸ”§ Footgun Manual - æ•°æ®ç«äº‰ä¿®å¤ç»ƒä¹ "
	@echo ""
	@echo "ğŸ“‹ å¯ç”¨å‘½ä»¤:"
	@echo "  make run              - è¿è¡Œä½ çš„ä¿®å¤ç‰ˆæœ¬ (è°ƒè¯•æ¨¡å¼)"
	@echo "  make run-release      - è¿è¡Œä½ çš„ä¿®å¤ç‰ˆæœ¬ (å‘å¸ƒæ¨¡å¼)"
	@echo "  make optimized        - è¿è¡Œä¼˜åŒ–ç‰ˆæœ¬ (è°ƒè¯•æ¨¡å¼)"
	@echo "  make optimized-release- è¿è¡Œä¼˜åŒ–ç‰ˆæœ¬ (å‘å¸ƒæ¨¡å¼)"
	@echo "  make compare          - å¯¹æ¯”ä¸‰ä¸ªç‰ˆæœ¬çš„è¾“å‡º"
	@echo "  make bench            - æ€§èƒ½åŸºå‡†æµ‹è¯•"
	@echo "  make check            - æ£€æŸ¥ä»£ç ç¼–è¯‘"
	@echo "  make clippy           - è¿è¡Œ clippy ä»£ç æ£€æŸ¥"
	@echo "  make fmt              - æ ¼å¼åŒ–ä»£ç "
	@echo "  make test             - è¿è¡Œæµ‹è¯•"
	@echo "  make clean            - æ¸…ç†æ„å»ºæ–‡ä»¶"
	@echo "  make all              - è¿è¡Œæ‰€æœ‰æ£€æŸ¥å’Œæµ‹è¯•"
	@echo "  make install-deps     - å®‰è£…ä¾èµ–å·¥å…·"
	@echo ""
	@echo "ğŸ¯ å¿«é€Ÿå¼€å§‹: make run"

# è¿è¡Œä½ çš„ä¿®å¤ç‰ˆæœ¬
run:
	@echo "ğŸš€ è¿è¡Œä½ çš„ä¿®å¤ç‰ˆæœ¬..."
	cargo run

# è¿è¡Œä½ çš„ä¿®å¤ç‰ˆæœ¬ (å‘å¸ƒæ¨¡å¼)
run-release:
	@echo "ğŸš€ è¿è¡Œä½ çš„ä¿®å¤ç‰ˆæœ¬ (å‘å¸ƒæ¨¡å¼)..."
	cargo run --release

# ç¼–è¯‘å¹¶è¿è¡Œä¼˜åŒ–ç‰ˆæœ¬
optimized:
	@echo "ğŸ”§ ç¼–è¯‘ä¼˜åŒ–ç‰ˆæœ¬..."
	rustc src/main_optimized.rs -o main_optimized
	@echo "ğŸš€ è¿è¡Œä¼˜åŒ–ç‰ˆæœ¬..."
	./main_optimized
	@echo "ğŸ§¹ æ¸…ç†å¯æ‰§è¡Œæ–‡ä»¶..."
	rm -f main_optimized

# ç¼–è¯‘å¹¶è¿è¡Œä¼˜åŒ–ç‰ˆæœ¬ (å‘å¸ƒæ¨¡å¼)
optimized-release:
	@echo "ğŸ”§ ç¼–è¯‘ä¼˜åŒ–ç‰ˆæœ¬ (å‘å¸ƒæ¨¡å¼)..."
	rustc src/main_optimized.rs -O -o main_optimized
	@echo "ğŸš€ è¿è¡Œä¼˜åŒ–ç‰ˆæœ¬..."
	./main_optimized
	@echo "ğŸ§¹ æ¸…ç†å¯æ‰§è¡Œæ–‡ä»¶..."
	rm -f main_optimized

# å¯¹æ¯”ä¸‰ä¸ªç‰ˆæœ¬çš„è¾“å‡º
compare:
	@echo "ğŸ“Š å¯¹æ¯”æ‰€æœ‰ç‰ˆæœ¬çš„è¿è¡Œç»“æœ"
	@echo ""
	@echo "=== 1. åŸå§‹ç‰ˆæœ¬ (æœ‰æ•°æ®ç«äº‰) ==="
	@cd ../footgun && cargo run --release 2>/dev/null | head -20
	@echo ""
	@echo "=== 2. ä½ çš„ä¿®å¤ç‰ˆæœ¬ ==="
	@cargo run --release 2>/dev/null
	@echo ""
	@echo "=== 3. ä¼˜åŒ–ç‰ˆæœ¬ ==="
	@rustc src/main_optimized.rs -O -o main_optimized 2>/dev/null
	@./main_optimized | head -25
	@rm -f main_optimized
	@echo ""
	@echo "âœ… å¯¹æ¯”å®Œæˆï¼æ³¨æ„æ•°æ®ç«äº‰ç‰ˆæœ¬çš„ç»“æœæ¯æ¬¡éƒ½ä¸åŒ"

# æ€§èƒ½åŸºå‡†æµ‹è¯•
bench:
	@echo "â±ï¸  æ€§èƒ½åŸºå‡†æµ‹è¯• (5æ¬¡è¿è¡Œ)"
	@echo ""
	@echo "--- ä½ çš„ç‰ˆæœ¬ (å‘å¸ƒæ¨¡å¼) ---"
	@for i in 1 2 3 4 5; do \
		echo -n "Run $$i: "; \
		time cargo run --release 2>&1 | grep -E "(real|user|sys)" | tr -d '\n'; \
		echo ""; \
	done
	@echo ""
	@echo "--- ä¼˜åŒ–ç‰ˆæœ¬ (å‘å¸ƒæ¨¡å¼) ---"
	@rustc src/main_optimized.rs -O -o main_optimized 2>/dev/null
	@for i in 1 2 3 4 5; do \
		echo -n "Run $$i: "; \
		time ./main_optimized 2>&1 | grep -E "(real|user|sys)" | tr -d '\n'; \
		echo ""; \
	done
	@rm -f main_optimized

# æ£€æŸ¥ä»£ç ç¼–è¯‘
check:
	@echo "ğŸ” æ£€æŸ¥ä»£ç ç¼–è¯‘..."
	cargo check
	@echo "ğŸ” æ£€æŸ¥ä¼˜åŒ–ç‰ˆæœ¬..."
	rustc --check src/main_optimized.rs

# è¿è¡Œ clippy ä»£ç æ£€æŸ¥
clippy:
	@echo "ğŸ“ è¿è¡Œ clippy æ£€æŸ¥..."
	cargo clippy -- -D warnings
	@echo "ğŸ“ æ£€æŸ¥ä¼˜åŒ–ç‰ˆæœ¬..."
	rustc src/main_optimized.rs --cfg clippy

# æ ¼å¼åŒ–ä»£ç 
fmt:
	@echo "ğŸ¨ æ ¼å¼åŒ–ä»£ç ..."
	cargo fmt
	@echo "ğŸ¨ æ ¼å¼åŒ–ä¼˜åŒ–ç‰ˆæœ¬..."
	rustfmt src/main_optimized.rs

# è¿è¡Œæµ‹è¯•
test:
	@echo "ğŸ§ª è¿è¡Œæµ‹è¯•..."
	cargo test
	@echo "ğŸ§ª éªŒè¯ä¼˜åŒ–ç‰ˆæœ¬è¾“å‡º..."
	@rustc src/main_optimized.rs -O -o main_optimized 2>/dev/null
	@result=$$(./main_optimized | grep "æœ€ç»ˆè®¡æ•°" | grep -o "[0-9]*"); \
	if [ "$$result" = "1000000" ]; then \
		echo "âœ… ä¼˜åŒ–ç‰ˆæœ¬æµ‹è¯•é€šè¿‡"; \
	else \
		echo "âŒ ä¼˜åŒ–ç‰ˆæœ¬æµ‹è¯•å¤±è´¥: $$result"; \
	fi
	@rm -f main_optimized

# æ¸…ç†æ„å»ºæ–‡ä»¶
clean:
	@echo "ğŸ§¹ æ¸…ç†æ„å»ºæ–‡ä»¶..."
	cargo clean
	rm -f main_optimized
	rm -f *.pdb
	@echo "âœ… æ¸…ç†å®Œæˆ"

# è¿è¡Œæ‰€æœ‰æ£€æŸ¥å’Œæµ‹è¯•
all: check clippy fmt test
	@echo "âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼"

# å®‰è£…ä¾èµ–å·¥å…·
install-deps:
	@echo "ğŸ“¦ å®‰è£…å¼€å‘ä¾èµ–..."
	rustup component add clippy
	rustup component add rustfmt
	@echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

# å¿«é€ŸéªŒè¯ä¿®å¤æ˜¯å¦æˆåŠŸ
validate:
	@echo "ğŸ”¬ éªŒè¯æ•°æ®ç«äº‰ä¿®å¤..."
	@echo ""
	@echo "æµ‹è¯•ä½ çš„ç‰ˆæœ¬ (5æ¬¡è¿è¡Œ):"
	@consistent=true; \
	for i in 1 2 3 4 5; do \
		result=$$(cargo run --release 2>/dev/null); \
		if [ "$$result" != "1000000" ]; then \
			echo "Run $$i: âŒ $$result (ä¸æ­£ç¡®)"; \
			consistent=false; \
		else \
			echo "Run $$i: âœ… $$result (æ­£ç¡®)"; \
		fi; \
	done; \
	if [ "$$consistent" = "true" ]; then \
		echo "ğŸ‰ ä¿®å¤éªŒè¯é€šè¿‡ï¼ç»“æœå®Œå…¨ä¸€è‡´ä¸”æ­£ç¡®"; \
	else \
		echo "âš ï¸  ä¿®å¤å¯èƒ½æœ‰é—®é¢˜ï¼Œç»“æœä¸ä¸€è‡´"; \
	fi

# æ˜¾ç¤ºé¡¹ç›®ä¿¡æ¯
info:
	@echo "ğŸ“ é¡¹ç›®ä¿¡æ¯:"
	@echo "  å½“å‰ç›®å½•: $$(pwd)"
	@echo "  Rustç‰ˆæœ¬: $$(rustc --version)"
	@echo "  Cargoç‰ˆæœ¬: $$(cargo --version)"
	@echo ""
	@echo "ğŸ“‚ æ–‡ä»¶ç»“æ„:"
	@find . -name "*.rs" -o -name "*.toml" -o -name "*.md" -o -name "Makefile" | sort

# ç”Ÿæˆæ–‡æ¡£
docs:
	@echo "ğŸ“– ç”Ÿæˆæ–‡æ¡£..."
	cargo doc --open

# ç»Ÿè®¡ä»£ç è¡Œæ•°
stats:
	@echo "ğŸ“Š ä»£ç ç»Ÿè®¡:"
	@echo "ä½ çš„ç‰ˆæœ¬ (main.rs):"
	@wc -l src/main.rs
	@echo "ä¼˜åŒ–ç‰ˆæœ¬ (main_optimized.rs):"
	@wc -l src/main_optimized.rs
	@echo "æ€»è®¡:"
	@find src -name "*.rs" -exec wc -l {} + | tail -1